#!/bin/bash

# iptables configuration script
# Generated by Ansible

ipt4="/usr/sbin/iptables"
ipt6="/usr/sbin/ip6tables"
int=$(route -n | grep -E "0.0.0.0.*0.0.0.0" | awk '{ print $8 }')

{% if always_allowed_hosts is defined and always_allowed_hosts | length > 0 %}
### Allow traffic from trusted hosts
{% for host in always_allowed_hosts %}
{% if host is match("^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$") %}
${ipt4} -j ACCEPT -A INPUT -s {{ host }} -i ${int}
{% else %}
${ipt6} -j ACCEPT -A INPUT -s {{ host }} -i ${int}
{% endif %}
{% endfor %}

{% endif %}
{% if iptables_extra_rules is defined and iptables_extra_rules | length > 0 %}
### Additional iptables rules
{% for rule in iptables_extra_rules %}
{{ rule }}
{% endfor %}

{% endif %}
### DROP Zabbix agent port from all except allowed hosts
${ipt4} -j DROP -A INPUT -4 -p tcp -i ${int} --dport {{ zabbix_agent_port | default(10050) }}
${ipt6} -j DROP -A INPUT -6 -p tcp -i ${int} --dport {{ zabbix_agent_port | default(10050) }}

{% if vpn_network is defined and vpn_bmask is defined %}
### NAT for VPN network (IPv4 only)
${ipt4} -t nat -A POSTROUTING -s {{ vpn_network }}/{{ vpn_bmask }} -d 0.0.0.0/0 -o ${int} -j MASQUERADE
{% endif %}
