---
- name: Manage user accounts
  user:
    name: "{{ item.username }}"
    comment: "{{ item.fullname | default('Managed by Ansible') }}"
    uid: "{{ item.uid | default(omit) }}"
    groups: "{{ item.groups | join(',') if item.groups is defined else omit }}"
    # append: no # Default is no, which means groups will be set exactly to the list provided (plus primary group)
    shell: "{{ item.shell | default('/bin/bash') }}"
    home: "{{ item.home_root | default('/home/' + item.username) }}"
    create_home: yes
    state: "{{ item.state | default('present') }}"
    remove: "{{ 'yes' if (item.state | default('present')) == 'absent' else 'no' }}"
  loop: "{{ ssh_users_list }}"
  loop_control:
    label: "{{ item.username }}"

- name: Ensure .ssh directory exists with secure permissions
  file:
    path: "{{ item.home_root | default('/home/' + item.username) }}/.ssh"
    state: directory
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: '0700'
  loop: "{{ ssh_users_list }}"
  loop_control:
    label: "{{ item.username }}"
  when: (item.state | default('present')) == 'present'

- name: Manage SSH authorized keys
  authorized_key:
    user: "{{ item.username }}"
    key: "{{ item.ssh_authorized_keys | join('\n') }}"
    state: present
    exclusive: yes
  loop: "{{ ssh_users_list }}"
  loop_control:
    label: "{{ item.username }}"
  when:
    - (item.state | default('present')) == 'present'
    - item.ssh_authorized_keys is defined

